# APP性能优化思路

## 背景

我们app和竞品存在性能差距，所以需要对核心页面进行性能优化。因此在这里我提供一些个人想法，抛转引玉，引出更好的想法

## 性能优化的目标

性能优化目标就是用最少的时间，给用户提供服务。所以我有一些一下的理解：

- **无法避免必要的计算**
  1.能延后的计算
  2.能提前的计算
  3.能用更高效率的计算方式实现

- **能避免的计算**

上面计算就是指为了达到用户需要的服务，需要进行的CPU计算。



## 页面加载过程分析

**加载过程大致可以分为一下几类**

1. 从点击开始交互开始，
2. 路由组件进行路由传参
3. 创建UIKit相关的VC，以及View。
4. 网络请求
5. 数据解析
6. 取出数据进行渲染

**针对“1和2”**，我这边考虑的是使用 “提前的计算”。比如在购物车的时候，我就把下单页的页面进行了预先初步初始化

这样，用户点击调到下单页的时候，我们这边就可以使用原来的VC直接进行跳转，并且传参触发新的请求（也是网络上流传的 昂贵的对象，我们进行复用，不销毁，但是我们这里是为了 省去 不必要重复创建VC和View，让它执行 网络层+数据解析+渲染就可以了）

**针对"3"网络请求**，因为iOS 上同一个域名URLSession最大的并发请求是6 httpmaximumconnectionsperhost，我们可以根据不同的业务来控制每个业务session的并发数(业务接口一定是优先级最高)。

另外我们可以尝试可以开启HTTPShouldUsePipelining（需要服务器支持）

**针对“4”数据解析**，如果可以，希望可以用上protobuf这种轻量的键值对传输载体（能用更高效率的计算方式实现）

差异更新：我们可以对checkout接口，非第一次的时候，客户端把对应的业务地址JSON值进行MD5传给后端，后端在返回的时候，MD5一下比较，如果是一致的话，对应的模块结构就不返回了。也就是那部分数据有变化才按需传输，

根据JSON的节点来？这只是我的一个猜想。比如地址MD5,运输方式MD5,支付列表MD5,价格模块MD5传给后端

**针对“5”**，就是尽量少重复的渲染，高优先级的内容（能延后的计算）

另外iPhone在低电量的时候会降频，我们可考虑针对低电量状态的设备进行过滤，探索一下有什么办法能临时提升频率的触发任务，不然就只能do more less。LowPowerMode



## 启动优化

启动优化，大部分的思路是 拦截业务的app 启动逻辑。延后到首页出现后，才执行业务处理

**延后执行**

比如启动过程有埋点触发，那么我们就不直接发送埋点，我们先把逻辑数据点记录到内存，直到首页出现后，我们才把它交给发送的埋点工具。

**减少不必要的计算等待**

启动的时候IO的读写，都是一次过就读取好数据。写入的时候也不直接写入，启动过程都记录在内存。

根据首页业务必要的SDK或者功能来加载，尽量达到最少的代码执行（比如普通启动就用不到推送的注册）

根据第三方库功能在什么时候用到的时候，才进行懒加载。或者说首页出现后执行。比如推送进入的话，会用到SDK，需要识别必要的SDK是那些，懒加载

另外一个就是启动代码不用OC的代码，全部用Swift的类，不继承NSObject。减少OC的消息动态派发

**多线程执行**
启动的时候按CPU核心来分配多个并发队列，让一些允许并发执行的任务来最大限度使用CPU的计算。不是越多越好，不要影响主线程。一般配置2个这样队列